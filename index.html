<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steam Batch Analyzer (Smart Engine)</title>
    <style>
        :root {
            --bg: #101216;
            --surface: #1b2838;
            --border: #2a475e;
            --accent: #66c0f4;
            --text: #c7d5e0;
            --success: #66c0f4; 
            --xbox: #107C10;
            --ps: #00439C;
            --switch: #e60012;
            --db-color: #e51376;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        h1 { margin: 0 0 15px 0; font-size: 20px; color: #fff; text-transform: uppercase; letter-spacing: 1px; }

        .controls {
            display: grid;
            grid-template-columns: 1fr 200px;
            gap: 15px;
            margin-bottom: 20px;
            background: var(--surface);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        textarea {
            width: 100%;
            height: 80px;
            background: #0d1015;
            border: 1px solid var(--border);
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            resize: none;
            font-family: monospace;
            box-sizing: border-box;
        }

        .actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button {
            flex: 1;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
            color: #fff;
        }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        #btnProcess { background: linear-gradient(90deg, #06BFFF, #2D73FF); }
        #btnExport { background: #4c6b22; display: none; }
        #btnClear { background: #3a3a3a; }

        .progress-container {
            width: 100%;
            height: 4px;
            background: #000;
            margin-bottom: 15px;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s;
        }

        .table-container {
            flex: 1;
            overflow: auto;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: #171a21;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            white-space: nowrap;
        }

        th {
            background: #20242b;
            position: sticky;
            top: 0;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: var(--accent);
            z-index: 10;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 8px 10px;
            border-bottom: 1px solid #2a3540;
            vertical-align: middle;
        }

        tr:hover { background: rgba(255,255,255,0.05); }

        .thumb { width: 30px; height: 30px; object-fit: cover; border-radius: 3px; }
        .score { font-weight: bold; color: #a1cd44; }
        .price-br { color: #fff; font-weight: 500; }
        .price-us { color: #888; font-size: 11px; }
        
        .plat-icon { 
            display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; 
            background: #444;
        }
        .plat-icon.active.pc { background: var(--accent); box-shadow: 0 0 5px var(--accent); }
        .plat-icon.active.ps { background: var(--ps); box-shadow: 0 0 5px var(--ps); }
        .plat-icon.active.xb { background: var(--xbox); box-shadow: 0 0 5px var(--xbox); }
        .plat-icon.active.sw { background: var(--switch); box-shadow: 0 0 5px var(--switch); }

        .trend-up { color: #a1cd44; }
        .trend-down { color: #cd5444; }
        .status-loading { color: var(--accent); font-style: italic; }
        .status-error { color: #cd5444; }

        .db-link {
            background-color: #2b1c3d;
            color: #d8b4fe;
            padding: 3px 8px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 11px;
            border: 1px solid #5a3c7d;
            transition: all 0.2s;
        }
        .db-link:hover { background-color: var(--db-color); color: white; border-color: white;}

        .game-link {
            color: #66c0f4;
            text-decoration: none;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h1>Analisador Batch (Filtro Engine)</h1>

    <div class="controls">
        <div>
            <textarea id="inputList" placeholder="Cole aqui sua lista de jogos (Links, IDs ou Nomes)."></textarea>
        </div>
        <div class="actions">
            <button id="btnProcess" onclick="startBatch()">PROCESSAR LISTA</button>
            <button id="btnExport" onclick="exportToCSV()">BAIXAR CSV (EXCEL)</button>
            <button id="btnClear" onclick="clearTable()">LIMPAR</button>
        </div>
    </div>

    <div class="progress-container" id="progressBox">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="table-container">
        <table id="dataTable">
            <thead>
                <tr>
                    <th style="width: 40px;">Img</th>
                    <th>Nome do Jogo</th>
                    <th>Status</th>
                    <th>Pre√ßo (BRL)</th>
                    <th>Pre√ßo (USD)</th>
                    <th>Score</th>
                    <th>Lan√ßamento</th>
                    <th>Plataformas</th>
                    <th>Engine</th>
                    <th>Jogadores (Agora)</th>
                    <th>Tend√™ncia (6m)</th>
                    <th>Desenvolvedor</th>
                    <th>ID</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

<script>
    // Proxy alternativo para evitar bloqueios do corsproxy.io
    const CORS_PROXY = "https://api.allorigins.win/raw?url=";
    let processedData = []; 
    const ACCEPTED_ENGINES = ['unity', 'unreal', 'gamemaker', 'game maker', 'godot'];

    async function startBatch() {
        const input = document.getElementById('inputList').value;
        if(!input.trim()) return alert("A lista est√° vazia.");

        clearTable();
        document.getElementById('btnExport').style.display = 'none';
        const progressBox = document.getElementById('progressBox');
        const progressBar = document.getElementById('progressBar');
        progressBox.style.display = 'block';
        progressBar.style.width = '0%';

        let items = input.split(/[\n,;]+/).map(s => s.trim()).filter(s => s.length > 0);
        let total = items.length;
        let completed = 0;

        items.forEach((item, index) => createRow(index, item));

        for (let i = 0; i < total; i++) {
            try {
                updateCell(i, 'status', 'Buscando ID...', 'status-loading');
                let appId = await resolveID(items[i]);
                
                processedData[i] = { id: appId }; 
                
                updateCell(i, 'id', appId);
                updateCell(i, 'status', 'Baixando Dados...', 'status-loading');

                let steamData = await fetchSteamBase(appId);
                fillRowBasic(i, steamData);
                
                await Promise.all([
                    verifyExternalData(i, steamData.name, appId),
                    fetchTrends(i, appId)
                ]);

                updateCell(i, 'status', 'Conclu√≠do', 'trend-up');
                saveToMemory(i, steamData, appId);

            } catch (err) {
                console.error("Erro:", err);
                updateCell(i, 'status', 'Erro: ' + err.message, 'status-error');
                if(!processedData[i]) processedData[i] = { id: '?', name: items[i] };
            }
            completed++;
            progressBar.style.width = `${(completed/total)*100}%`;
            // Pequeno delay para evitar rate limit
            await new Promise(r => setTimeout(r, 300));
        }
        document.getElementById('btnExport').style.display = 'block';
    }

    function createRow(index, rawInput) {
        const tbody = document.querySelector('#dataTable tbody');
        const tr = document.createElement('tr');
        tr.id = `row-${index}`;
        tr.innerHTML = `
            <td><div class="thumb" style="background:#333"></div></td>
            <td id="cell-${index}-name">${rawInput}</td>
            <td id="cell-${index}-status" style="font-size:11px; color:#888;">Aguardando...</td>
            <td id="cell-${index}-brl">---</td>
            <td id="cell-${index}-usd">---</td>
            <td id="cell-${index}-score">---</td>
            <td id="cell-${index}-date">---</td>
            <td id="cell-${index}-plats">
                <span class="plat-icon pc active" title="PC"></span>
                <span class="plat-icon ps" id="icon-${index}-ps" title="PlayStation"></span>
                <span class="plat-icon xb" id="icon-${index}-xb" title="Xbox"></span>
                <span class="plat-icon sw" id="icon-${index}-sw" title="Switch"></span>
            </td>
            <td id="cell-${index}-engine">---</td>
            <td id="cell-${index}-players">---</td>
            <td id="cell-${index}-trend">---</td>
            <td id="cell-${index}-dev">---</td>
            <td id="cell-${index}-id" style="font-family:monospace; color:#555">---</td>
        `;
        tbody.appendChild(tr);
    }

    function updateCell(rowIdx, field, value, className = '') {
        const cell = document.getElementById(`cell-${rowIdx}-${field}`);
        if(cell) {
            cell.innerHTML = value;
            if(className) cell.className = className;
        }
    }

    function clearTable() {
        document.querySelector('#dataTable tbody').innerHTML = '';
        processedData = [];
    }

    async function resolveID(input) {
        if (/^\d+$/.test(input)) return input;
        const linkMatch = input.match(/\/app\/(\d+)/);
        if (linkMatch) return linkMatch[1];
        
        const searchUrl = `${CORS_PROXY}${encodeURIComponent('https://store.steampowered.com/search/?term=' + input)}`;
        const res = await fetch(searchUrl);
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, "text/html");
        const first = doc.querySelector('#search_resultsRows a');
        if(!first) throw new Error("N√£o encontrado");
        return first.getAttribute('data-ds-appid').split(',')[0];
    }

    async function fetchSteamBase(appId) {
        const brUrl = `${CORS_PROXY}${encodeURIComponent(`https://store.steampowered.com/api/appdetails?appids=${appId}&l=brazilian&cc=br`)}`;
        const usUrl = `${CORS_PROXY}${encodeURIComponent(`https://store.steampowered.com/api/appdetails?appids=${appId}&cc=us`)}`;
        
        const [resBr, resUs] = await Promise.all([
            fetch(brUrl).then(r => r.json()), 
            fetch(usUrl).then(r => r.json())
        ]);

        // Verifica√ß√£o robusta: a API pode retornar appId como n√∫mero ou string no objeto
        const dataKey = Object.keys(resBr)[0]; 
        if (!resBr[dataKey] || !resBr[dataKey].success) {
            throw new Error("ID n√£o reconhecido pela Steam");
        }

        const d = resBr[dataKey].data;
        const dUs = resUs[dataKey]?.success ? resUs[dataKey].data : null;

        return {
            name: d.name || "Sem Nome",
            img: d.capsule_image || d.header_image || "",
            priceBr: d.is_free ? "Gr√°tis" : (d.price_overview?.final_formatted || 'N/A'),
            priceUs: d.is_free ? "Free" : (dUs?.price_overview?.final_formatted || 'N/A'),
            score: d.metacritic?.score || '',
            date: d.release_date?.date || '',
            dev: d.developers?.[0] || ''
        };
    }

    function fillRowBasic(idx, data) {
        const row = document.getElementById(`row-${idx}`);
        const appId = processedData[idx].id; 
        if(data.img) row.querySelector('.thumb').outerHTML = `<img src="${data.img}" class="thumb">`;
        
        updateCell(idx, 'name', `<a href="https://store.steampowered.com/app/${appId}" target="_blank" class="game-link">${data.name}</a>`);
        updateCell(idx, 'brl', data.priceBr, 'price-br');
        updateCell(idx, 'usd', data.priceUs, 'price-us');
        updateCell(idx, 'score', data.score, 'score');
        updateCell(idx, 'date', data.date);
        updateCell(idx, 'dev', data.dev);
    }

    async function verifyExternalData(idx, gameName, appId) {
        const steamDbLink = `<a href="https://steamdb.info/app/${appId}/info/" target="_blank" class="db-link">SteamDB ‚Üó</a>`;
        
        try {
            const sApi = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(gameName + " video game")}&format=json&origin=*`;
            const sRes = await fetch(sApi).then(r=>r.json());
            
            if (sRes.query && sRes.query.search.length > 0) {
                const pApi = `https://en.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(sRes.query.search[0].title)}&prop=text&format=json&origin=*`;
                const pRes = await fetch(pApi).then(r=>r.json());
                const doc = new DOMParser().parseFromString(pRes.parse.text['*'], "text/html");
                
                const infobox = doc.querySelector('.infobox');
                let rawEngine = null;
                let allText = "";

                if(infobox) {
                    const rows = infobox.querySelectorAll('tr');
                    rows.forEach(r => {
                        const h = r.querySelector('th')?.innerText.toLowerCase()||"";
                        const v = r.querySelector('td')?.innerText||"";
                        if(h.includes('engine')) rawEngine = v;
                        if(h.includes('platform')) allText += v + " ";
                    });
                }

                if (rawEngine) {
                    const engineLower = rawEngine.toLowerCase();
                    const isAccepted = ACCEPTED_ENGINES.some(eng => engineLower.includes(eng));
                    updateCell(idx, 'engine', isAccepted ? rawEngine : steamDbLink);
                } else {
                    updateCell(idx, 'engine', steamDbLink);
                }

                const t = allText.toLowerCase();
                if(t.includes('playstation') || t.includes('ps4') || t.includes('ps5')) document.getElementById(`icon-${idx}-ps`).classList.add('active');
                if(t.includes('xbox')) document.getElementById(`icon-${idx}-xb`).classList.add('active');
                if(t.includes('switch') || t.includes('nintendo')) document.getElementById(`icon-${idx}-sw`).classList.add('active');
            } else {
                 updateCell(idx, 'engine', steamDbLink);
            }
        } catch(e) { 
            updateCell(idx, 'engine', steamDbLink);
        }
    }

    async function fetchTrends(idx, appId) {
        try {
            const url = `${CORS_PROXY}${encodeURIComponent('https://steamcharts.com/app/' + appId)}`;
            const res = await fetch(url);
            const text = await res.text();
            const doc = new DOMParser().parseFromString(text, "text/html");
            const current = doc.querySelector('.app-stat .num')?.innerText || "-";
            updateCell(idx, 'players', current);

            const rows = doc.querySelectorAll('table.common-table tbody tr');
            if(rows.length > 6) {
                const now = parseFloat(rows[0].children[1].innerText.replace(/,/g, ''));
                const m6 = parseFloat(rows[6].children[1].innerText.replace(/,/g, ''));
                const diff = ((now - m6)/m6)*100;
                let symbol = diff > 0 ? "üìà +" : "üìâ ";
                updateCell(idx, 'trend', `${symbol}${diff.toFixed(1)}%`, diff > 0 ? "trend-up" : "trend-down");
            }
        } catch(e) { updateCell(idx, 'trend', '?'); }
    }

    function saveToMemory(idx, steamData, appId) {
        const engineCell = document.getElementById(`cell-${idx}-engine`);
        processedData[idx] = {
            id: appId,
            name: steamData.name,
            priceBr: steamData.priceBr,
            priceUs: steamData.priceUs,
            score: steamData.score,
            date: steamData.date,
            dev: steamData.dev,
            engine: engineCell.innerText.includes("SteamDB") ? "SteamDB" : engineCell.innerText,
            players: document.getElementById(`cell-${idx}-players`).innerText,
            trend: document.getElementById(`cell-${idx}-trend`).innerText,
            ps: document.getElementById(`icon-${idx}-ps`).classList.contains('active') ? "Sim" : "N√£o",
            xb: document.getElementById(`icon-${idx}-xb`).classList.contains('active') ? "Sim" : "N√£o",
            sw: document.getElementById(`icon-${idx}-sw`).classList.contains('active') ? "Sim" : "N√£o",
            link: `https://store.steampowered.com/app/${appId}`
        };
    }

    function exportToCSV() {
        if(processedData.length === 0) return alert("Nada para exportar");
        let csvContent = "\uFEFF"; 
        csvContent += "ID,Nome,Preco_BRL,Preco_USD,Score,Lancamento,Dev,Engine,Jogadores_Ativos,Tendencia_6m,PC,PSN,Xbox,Switch,Link_Steam\n";
        processedData.forEach(row => {
            if(!row || !row.id) return;
            const escape = (txt) => `"${String(txt || '').replace(/"/g, '""')}"`;
            let line = [row.id, escape(row.name), escape(row.priceBr), escape(row.priceUs), row.score, escape(row.date), escape(row.dev), escape(row.engine), escape(row.players), escape(row.trend), "Sim", row.ps, row.xb, row.sw, row.link].join(",");
            csvContent += line + "\n";
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "analise_steam.csv";
        link.click();
    }
</script>
</body>
</html>
